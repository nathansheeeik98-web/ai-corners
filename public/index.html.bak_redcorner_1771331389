<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IA Escanteios ‚Äî Ultra</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#0c1220;
      --card:#111a2b;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --muted2:rgba(233,238,252,.55);

      --primary:#6ea8ff;
      --primary2:#3f7cff;

      --good:#38d39f;
      --warn:#ffd166;
      --bad:#ff5c7a;

      --radius:18px;
      --shadow2: 0 10px 22px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(110,168,255,.18), transparent 60%),
        radial-gradient(900px 600px at 100% 30%, rgba(56,211,159,.14), transparent 55%),
        radial-gradient(900px 600px at 10% 100%, rgba(255,92,122,.10), transparent 50%),
        var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,15,23,.86), rgba(11,15,23,.62));
      border-bottom:1px solid var(--stroke);
    }
    .topbar .inner{
      max-width:1140px;margin:0 auto;padding:12px 14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .statusline{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--stroke);
      background: rgba(15,22,36,.65);
      border-radius:999px;
      font-size:12px;color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .wrap{max-width:1140px;margin:0 auto;padding:14px 14px 36px}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-top:12px;
    }
    .tabbtn{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(15,22,36,.70);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    .tabbtn.active{
      background: linear-gradient(180deg, rgba(110,168,255,1), rgba(63,124,255,1));
      color:#07101f;
      border:none;
      box-shadow: 0 12px 25px rgba(63,124,255,.22);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(17,26,43,.96), rgba(12,18,32,.96));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card .hd .title{font-weight:800;font-size:13px;letter-spacing:.2px}
    .card .hd .desc{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.25}
    .card .bd{padding:14px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:140px}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,button{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(10,14,22,.65);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    input::placeholder{color:rgba(233,238,252,.38)}
    select{appearance:none}

    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}

    .btn{
      border:none;
      background: linear-gradient(180deg, rgba(110,168,255,1), rgba(63,124,255,1));
      color:#07101f;
      font-weight:900;
      box-shadow: 0 12px 25px rgba(63,124,255,.22);
    }
    .btn2{
      background: rgba(15,22,36,.78);
      border:1px solid var(--stroke2);
      color:var(--text);
      font-weight:700;
    }
    .btnDanger{
      background: rgba(255,92,122,.14);
      border:1px solid rgba(255,92,122,.35);
      color: var(--text);
      font-weight:800;
    }

    .list{
      max-height: 430px;
      overflow:auto;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(10,14,22,.55);
    }
    .item{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .item:last-child{border-bottom:none}
    .item .line1{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .item .line1 b{font-size:13px}
    .item .line2{margin-top:4px;font-size:12px;color:var(--muted)}
    .item .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .item .actions button{flex:1;min-width:140px}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 9px;border-radius:999px;
      border:1px solid var(--stroke);
      font-size:12px;color:var(--muted);
      background: rgba(15,22,36,.70);
    }
    .badge.good{border-color: rgba(56,211,159,.45); background: rgba(56,211,159,.10); color: rgba(233,238,252,.92)}
    .badge.warn{border-color: rgba(255,209,102,.55); background: rgba(255,209,102,.10); color: rgba(233,238,252,.92)}
    .badge.bad{border-color: rgba(255,92,122,.55); background: rgba(255,92,122,.12); color: rgba(233,238,252,.95)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    pre{
      margin:0;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(10,14,22,.70);
      color: rgba(233,238,252,.92);
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.35;
      font-size:12.5px;
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi .box{
      padding:10px 10px;border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(15,22,36,.55);
    }
    .kpi .box .t{font-size:11px;color:var(--muted)}
    .kpi .box .v{margin-top:3px;font-size:14px;font-weight:900}

    .footnote{font-size:12px;color:var(--muted2);line-height:1.35}

    .split{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width: 980px){
      .split{grid-template-columns: 420px 1fr}
    }

    .star{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;border-radius:12px;
      border:1px solid var(--stroke2);
      background: rgba(15,22,36,.78);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .star.on{
      border-color: rgba(255,209,102,.65);
      background: rgba(255,209,102,.14);
      color: rgba(233,238,252,.95);
    }
  </style>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0f17">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <h1>IA Escanteios ‚Äî Ultra</h1>
        <div class="sub">Tabs ‚Ä¢ Debounce ‚Ä¢ Favoritos ‚Ä¢ Ranking ‚Ä¢ Alertas ‚Ä¢ Top 5 ‚Ä¢ Top 5 Ligas ‚≠ê</div>
      </div>
      <div class="statusline">
        <span class="chip"><span class="dot good"></span><span id="statusText">Pronto</span></span>
        <span class="chip"><span class="dot warn"></span><span id="quotaHint">‚ÄúAvaliar‚Äù gasta stats</span></span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="tabs">
      <button class="tabbtn active" data-tab="tab-live">Ao vivo</button>
      <button class="tabbtn" data-tab="tab-best">Melhores</button>
      <button class="tabbtn" data-tab="tab-favs">Favoritos</button>
      <button class="tabbtn" data-tab="tab-monitor">Monitor</button>
      <button class="tabbtn" data-tab="tab-config">Config</button>
    </div>

    <!-- AO VIVO -->
    <section id="tab-live" class="grid" style="display:block">
      <div class="split">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Controles r√°pidos</div>
              <div class="desc">Carregar √© barato. Avaliar puxa stats (gasta). Janela avaliar: 12‚Äì85‚Äô. Ranking: 15‚Äì75‚Äô.</div>
            </div>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label>Buscar (debounce)</label>
                <input id="filter" placeholder="Ex: Brazil / Premier / Arsenal" />
              </div>
              <div>
                <label>Alerta m√≠nimo (conf.)</label>
                <select id="alertMin">
                  <option value="75">75</option>
                  <option value="80" selected>80</option>
                  <option value="85">85</option>
                  <option value="90">90</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Cooldown avaliar (seg)</label>
                <input id="cooldown" type="number" value="10" />
              </div>
              <div>
                <label>Status auto</label>
                <input id="autoStatus" placeholder="‚Äî" readonly />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div><button class="btn2" id="loadLive">Carregar jogos ao vivo</button></div>
              <div><button class="btn" id="evalTop5">Avaliar Top 5 (econ√¥mico)</button></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div><button class="btn" id="evalTop5Leagues">Top 5 Melhores Ligas ‚≠ê</button></div>
              <div><button class="btn2 btnDanger" id="stopAuto">Parar auto-avalia√ß√£o</button></div>
            </div>

            <div class="kpi" id="meta"></div>

            <div class="footnote" style="margin-top:10px">
              ‚ö†Ô∏è Sem promessa de lucro. Assistente de decis√£o.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Jogos ao vivo</div>
              <div class="desc">‚≠ê Favoritar salva no celular. ‚ÄúAvaliar‚Äù s√≥ na janela 12‚Äì85‚Äô.</div>
            </div>
          </div>
          <div class="bd">
            <div class="list" id="liveList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MELHORES -->
    <section id="tab-best" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">üî• Melhores jogos agora</div>
            <div class="desc">S√≥ entra no ranking se estiver entre 15‚Äì75‚Äô e n√£o estiver bloqueado (‚â§20‚Äô com 0 escanteios).</div>
          </div>
        </div>
        <div class="bd">
          <div class="list" id="bestNow"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Resultado / A√ß√£o</div>
            <div class="desc">O que fazer agora (heur√≠stica/IA).</div>
          </div>
        </div>
        <div class="bd">
          <pre id="out">Clique em ‚ÄúAvaliar‚Äù.</pre>
        </div>
      </div>
    </section>

    <!-- FAVORITOS -->
    <section id="tab-favs" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">‚≠ê Favoritos</div>
            <div class="desc">Salvos no seu dispositivo. Voc√™ pode avaliar ou monitorar direto daqui.</div>
          </div>
        </div>
        <div class="bd">
          <div class="list" id="favList"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">A√ß√µes r√°pidas</div>
            <div class="desc">Dica: favoritar 3‚Äì8 ligas que voc√™ gosta e rodar o Top 5 Ligas.</div>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div><button class="btn2" id="favExport">Exportar favoritos (JSON)</button></div>
            <div><button class="btn2 btnDanger" id="favClear">Limpar favoritos</button></div>
          </div>
          <div class="footnote" style="margin-top:10px">
            Export serve pra backup. Import manual (colando no console) eu coloco depois se quiser.
          </div>
        </div>
      </div>
    </section>

    <!-- MONITOR -->
    <section id="tab-monitor" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Monitoramento</div>
            <div class="desc">Monitora 1 jogo no servidor. Voc√™ pode for√ßar atualiza√ß√£o quando quiser.</div>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Fixture #1</label>
              <input id="fx1" placeholder="preenchido ao clicar em Monitorar" />
            </div>
            <div>
              <label>Monitorar</label>
              <button class="btn" id="setFx">Salvar & Monitorar</button>
            </div>
            <div>
              <label>Atualizar (gasta)</label>
              <button class="btn2" id="force">For√ßar atualiza√ß√£o agora</button>
            </div>
          </div>
          <div style="margin-top:10px">
            <pre id="snap">Sem dados ainda.</pre>
          </div>
        </div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="tab-config" class="grid" style="display:none">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Configura√ß√µes</div>
            <div class="desc">Ajustes do modo econ√¥mico e ligas ‚Äútop‚Äù.</div>
          </div>
        </div>
        <div class="bd">
          <div class="footnote">
            ‚Ä¢ Modo econ√¥mico: avaliar s√≥ 12‚Äì85‚Äô<br/>
            ‚Ä¢ Ranking: 15‚Äì75‚Äô<br/>
            ‚Ä¢ Bloqueio: ‚â§20‚Äô com 0 escanteios (ap√≥s avaliar)<br/>
            ‚Ä¢ Top ligas: lista interna (pode editar no c√≥digo)
          </div>
          <div class="row" style="margin-top:10px">
            <div><button class="btn2" id="goBest">Ir para Melhores</button></div>
            <div><button class="btn2" id="goLive">Ir para Ao vivo</button></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Sobre</div>
            <div class="desc">Interface local (Termux). Favoritos ficam no seu navegador.</div>
          </div>
        </div>
        <div class="bd">
          <div class="footnote">
            Se voc√™ limpar dados do navegador, favoritos somem. Use export pra backup.
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ===== Estado =====
  let LIVE_MEM = [];
  let EVAL_MEM = {};   // fixtureId -> { snapshot, heuristic, at }
  let BLOCKED = {};    // fixtureId -> reason string
  let FAVS = {};       // fixtureId -> { fixture_id, label, league, country }
  let lastEvalAt = 0;
  let lastAlertAt = 0;

  let AUTO_RUNNING = false;
  let AUTO_TOKEN = 0;

  // ‚≠ê Ligas top (pode editar)
  const TOP_LEAGUES = [
    "UEFA Champions League",
    "UEFA Europa League",
    "Premier League",
    "LaLiga",
    "Serie A",
    "Bundesliga",
    "Ligue 1",
    "Eredivisie",
    "Primeira Liga",
    "Copa Libertadores",
    "Copa Sudamericana",
    "Brasileir√£o Serie A",
    "Brasileir√£o Serie B",
    "MLS"
  ];

  const WINDOW_EVAL_MIN = 12;
  const WINDOW_EVAL_MAX = 85;
  const WINDOW_RANK_MIN = 15;
  const WINDOW_RANK_MAX = 75;
  const ALERT_COOLDOWN_MS = 120000;

  // ===== Util =====
  function setStatus(txt){
    $("statusText").textContent = txt || "Pronto";
    $("autoStatus").value = txt || "‚Äî";
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  function norm(s){ return String(s||"").toLowerCase().trim(); }

  function loadFavs(){
    try{
      const raw = localStorage.getItem("ai_corners_favs");
      FAVS = raw ? JSON.parse(raw) : {};
      if (!FAVS || typeof FAVS !== "object") FAVS = {};
    }catch{ FAVS = {}; }
  }
  function saveFavs(){
    localStorage.setItem("ai_corners_favs", JSON.stringify(FAVS));
  }
  function isFav(fid){ return !!FAVS[String(fid)]; }

  function isTopLeague(x){
    const lg = norm(x?.league||"");
    return TOP_LEAGUES.some(t => lg === norm(t) || lg.includes(norm(t)));
  }

  function beep() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = 880;
      g.gain.value = 0.06;
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 180);
      if (navigator.vibrate) navigator.vibrate([120, 80, 120]);
    } catch {}
  }

  function badge(text, kind=""){
    const k = kind ? ` ${kind}` : "";
    return `<span class="badge${k}">${text}</span>`;
  }

  function paceCorners(snapshot){
    const m = Number(snapshot?.minute || 0);
    const c = Number(snapshot?.corners_total || 0);
    if (!m) return 0;
    return c / m;
  }

  function evalScore(e){
    const h = e?.heuristic || {};
    const s = e?.snapshot || {};
    const conf = Number(h.confianca || 0);
    const m = Number(s.minute || 0);
    const cpm = paceCorners(s);
    const shots = Number(s.shots_total || 0);
    const sot = Number(s.shots_on_target || 0);

    let score = conf;
    score += Math.min(30, cpm * 180);
    score += Math.min(20, shots * 1.2);
    score += Math.min(10, sot * 1.8);
    if (m >= WINDOW_RANK_MIN && m <= WINDOW_RANK_MAX) score += 6;
    if (conf < 55) score -= 12;
    return Math.round(score);
  }

  function canEvaluateMinute(min){ return min >= WINDOW_EVAL_MIN && min <= WINDOW_EVAL_MAX; }
  function inRankWindow(min){ return min >= WINDOW_RANK_MIN && min <= WINDOW_RANK_MAX; }

  function renderMeta(){
    const el = $("meta");
    el.innerHTML = "";
    const mk = (t,v) => {
      const d = document.createElement("div");
      d.className = "box";
      d.innerHTML = `<div class="t">${t}</div><div class="v">${v}</div>`;
      return d;
    };
    const total = LIVE_MEM.length || 0;
    const evals = Object.keys(EVAL_MEM).length || 0;
    const blocked = Object.keys(BLOCKED).length || 0;
    const favs = Object.keys(FAVS).length || 0;
    el.appendChild(mk("Jogos", total));
    el.appendChild(mk("Avaliados", evals));
    el.appendChild(mk("Bloqueados", blocked));
    el.appendChild(mk("Favoritos", favs));
  }

  // ===== Tabs =====
  function showTab(id){
    document.querySelectorAll("section[id^='tab-']").forEach(s => s.style.display="none");
    document.getElementById(id).style.display="block";
    document.querySelectorAll(".tabbtn").forEach(b => b.classList.toggle("active", b.dataset.tab === id));
  }
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => showTab(btn.dataset.tab));
  });

  // ===== Debounce busca =====
  let filterTimer = null;
  function debounceFilter(){
    if (filterTimer) clearTimeout(filterTimer);
    filterTimer = setTimeout(() => {
      renderLiveList();
    }, 300);
  }
  $("filter").addEventListener("input", debounceFilter);

  // ===== Live list =====
  async function loadLive() {
    setStatus("Carregando lista...");
    $("liveList").innerHTML = `<div class="item">Carregando...</div>`;
    const r = await fetch("/api/live/list");
    const j = await r.json();
    if (!j.ok) {
      $("liveList").innerHTML = `<div class="item">Erro ao carregar: ${j.error || ""}</div>`;
      setStatus("Erro");
      return;
    }
    LIVE_MEM = j.items || [];
    setStatus("Lista pronta");
    renderLiveList();
    renderBestNow();
    renderFavList();
    renderMeta();
  }

  function toggleFav(it){
    const fid = String(it.fixture_id);
    if (FAVS[fid]) {
      delete FAVS[fid];
    } else {
      FAVS[fid] = {
        fixture_id: fid,
        label: `${it.home} vs ${it.away}`,
        league: it.league || "",
        country: it.country || ""
      };
    }
    saveFavs();
    renderLiveList();
    renderFavList();
    renderMeta();
  }

  function renderLiveList() {
    const filter = norm($("filter").value);
    const items = LIVE_MEM.filter(x => {
      if (!filter) return true;
      const blob = norm(`${x.country} ${x.league} ${x.home} ${x.away}`);
      return blob.includes(filter);
    }).slice(0, 160);

    const box = $("liveList");
    box.innerHTML = "";

    if (!items.length) {
      box.innerHTML = `<div class="item">Nada encontrado. Tente outro filtro.</div>`;
      return;
    }

    for (const it of items) {
      const fid = String(it.fixture_id);
      const ev = EVAL_MEM[fid];
      const blk = BLOCKED[fid];
      const m = Number(it.minute || 0);

      const minuteB = canEvaluateMinute(m) ? badge(`min ${m}`, "good") : badge(`min ${m} fora`, "warn");
      const topB = isTopLeague(it) ? badge("Liga ‚≠ê", "good") : "";
      const blockB = blk ? badge("BLOQUEADO", "bad") : "";
      const favStar = `<span class="star ${isFav(fid) ? "on" : ""}" title="Favoritar">${isFav(fid) ? "‚òÖ" : "‚òÜ"}</span>`;

      const evalB = ev
        ? (ev.heuristic.acao === "ENTRAR"
            ? badge(`ENTRAR ‚Ä¢ conf ${ev.heuristic.confianca}`, "good")
            : badge(`${ev.heuristic.acao} ‚Ä¢ conf ${ev.heuristic.confianca}`, "warn")
          ) + badge(ev.heuristic.linha_sugerida, "")
        : "";

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="line1">
          ${favStar}
          <b>${it.home}</b> <span style="opacity:.7">vs</span> <b>${it.away}</b>
          ${badge(it.score, "")}
          ${minuteB} ${topB} ${blockB} ${evalB}
        </div>
        <div class="line2">${it.country} ‚Ä¢ ${it.league} ‚Ä¢ fixture <span class="mono">${fid}</span>${blk ? " ‚Ä¢ " + blk : ""}</div>
        <div class="actions">
          <button class="btn2" data-eval="${fid}">Avaliar</button>
          <button class="btn2" data-mon="${fid}">Monitorar (#1)</button>
          <button class="btn2" data-show="${fid}">Ver</button>
        </div>
      `;

      div.querySelector(".star").onclick = () => toggleFav(it);

      div.querySelector('[data-mon]').onclick = () => { $("fx1").value = fid; showTab("tab-monitor"); };
      div.querySelector('[data-show]').onclick = () => {
        if (ev) { $("out").textContent = JSON.stringify(ev, null, 2); showTab("tab-best"); }
        else { $("out").textContent = "Ainda n√£o avaliado."; showTab("tab-best"); }
      };

      const evalBtn = div.querySelector('[data-eval]');
      evalBtn.onclick = () => evaluateFixture(it);
      if (!canEvaluateMinute(m)) evalBtn.disabled = true;

      box.appendChild(div);
    }
  }

  // ===== Ranking =====
  function renderBestNow() {
    const box = $("bestNow");
    const arr = Object.values(EVAL_MEM)
      .filter(e => {
        const m = Number(e?.snapshot?.minute || 0);
        const fid = String(e?.snapshot?.fixture_id || "");
        if (BLOCKED[fid]) return false;
        return inRankWindow(m);
      })
      .sort((a,b) => evalScore(b) - evalScore(a))
      .slice(0, 30);

    box.innerHTML = "";
    if (!arr.length) {
      box.innerHTML = `<div class="item">Sem ranking ainda. Avalie alguns jogos (ou use Top 5).</div>`;
      return;
    }

    for (const e of arr) {
      const s = e.snapshot;
      const h = e.heuristic;
      const fid = String(s.fixture_id);

      const cpm = paceCorners(s);
      const aBadge = h.acao === "ENTRAR" ? badge(`ENTRAR`, "good") : badge(h.acao, "warn");
      const confB = h.acao === "ENTRAR" ? badge(`Conf ${h.confianca}`, "good") : badge(`Conf ${h.confianca}`, "warn");

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="line1">
          <b>${s.match}</b>
          ${badge(s.score,"")}
          ${badge(`min ${s.minute}`,"")}
          ${aBadge}
          ${confB}
          ${badge(h.linha_sugerida,"")}
          ${badge(`Score ${evalScore(e)}`,"")}
        </div>
        <div class="line2">
          esc <b>${s.corners_total}</b> ‚Ä¢ ritmo <b>${cpm.toFixed(3)}</b>/min ‚Ä¢ chutes <b>${s.shots_total}</b> ‚Ä¢ no alvo <b>${s.shots_on_target}</b> ‚Ä¢ fixture <span class="mono">${fid}</span>
        </div>
        <div class="actions">
          <button class="btn2" data-mon="${fid}">Monitorar (#1)</button>
          <button class="btn2" data-view="${fid}">Ver detalhes</button>
        </div>
      `;
      div.querySelector('[data-mon]').onclick = () => { $("fx1").value = fid; showTab("tab-monitor"); };
      div.querySelector('[data-view]').onclick = () => { $("out").textContent = JSON.stringify(h, null, 2); };
      box.appendChild(div);
    }
  }

  // ===== Favoritos =====
  function renderFavList(){
    const box = $("favList");
    box.innerHTML = "";
    const items = Object.values(FAVS);

    if (!items.length){
      box.innerHTML = `<div class="item">Nenhum favorito ainda. V√° em ‚ÄúAo vivo‚Äù e aperte ‚òÜ.</div>`;
      return;
    }

    for (const f of items){
      const fid = String(f.fixture_id);
      const ev = EVAL_MEM[fid];
      const blk = BLOCKED[fid];

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="line1">
          <span class="star on" title="Remover">‚òÖ</span>
          <b>${f.label}</b>
          ${f.league ? badge(f.league, "") : ""}
          ${blk ? badge("BLOQUEADO","bad") : ""}
          ${ev ? badge(`Conf ${ev.heuristic.confianca}`, ev.heuristic.acao==="ENTRAR" ? "good":"warn") : ""}
        </div>
        <div class="line2">${f.country || ""} ‚Ä¢ fixture <span class="mono">${fid}</span></div>
        <div class="actions">
          <button class="btn2" data-eval="${fid}">Avaliar</button>
          <button class="btn2" data-mon="${fid}">Monitorar (#1)</button>
          <button class="btn2" data-del="${fid}">Remover</button>
        </div>
      `;
      div.querySelector(".star").onclick = () => {
        delete FAVS[fid]; saveFavs(); renderFavList(); renderMeta();
      };
      div.querySelector('[data-del]').onclick = () => {
        delete FAVS[fid]; saveFavs(); renderFavList(); renderMeta();
      };
      div.querySelector('[data-mon]').onclick = () => { $("fx1").value = fid; showTab("tab-monitor"); };

      div.querySelector('[data-eval]').onclick = async () => {
        // tenta achar no LIVE_MEM pra pegar minute etc, se n√£o achar: avalia mesmo (vai buscar snapshot via API)
        const it = LIVE_MEM.find(x => String(x.fixture_id) === fid) || { fixture_id: fid, minute: 45 };
        await evaluateFixture(it);
        showTab("tab-best");
      };

      box.appendChild(div);
    }
  }

  // ===== Avalia√ß√£o =====
  async function evaluateFixture(it, { silent = false } = {}) {
    const fid = String(it.fixture_id);
    const now = Date.now();
    const cd = Math.max(1, Number($("cooldown").value || 10)) * 1000;

    const minute = Number(it.minute || 0);
    if (minute && !canEvaluateMinute(minute)) {
      if (!silent) alert(`Super econ√¥mico: avaliar s√≥ entre ${WINDOW_EVAL_MIN} e ${WINDOW_EVAL_MAX} minutos.`);
      return { ok:false, reason:"minute_outside" };
    }

    if ((now - lastEvalAt) < cd) {
      if (!silent) {
        const wait = Math.ceil((cd - (now - lastEvalAt)) / 1000);
        alert(`Super econ√¥mico: aguarde ${wait}s para avaliar outro jogo.`);
      }
      return { ok:false, reason:"cooldown" };
    }

    lastEvalAt = now;
    if (!silent) $("out").textContent = "Avaliando (puxando stats)...";
    setStatus(`Avaliando fixture ${fid}...`);

    const r = await fetch(`/api/live/eval/${encodeURIComponent(fid)}`);
    const j = await r.json();
    if (!j.ok) {
      if (!silent) $("out").textContent = "Erro: " + (j.error || "");
      setStatus("Erro");
      return { ok:false, reason:"api_error" };
    }

    const snap = j.snapshot;
    const heur = j.heuristic;

    // bloqueio: ‚â§20 e 0 escanteios
    const m = Number(snap.minute || 0);
    const corners = Number(snap.corners_total || 0);
    if (m <= 20 && corners === 0) {
      BLOCKED[fid] = `Bloqueio: min ${m} com 0 escanteios.`;
    } else {
      if (BLOCKED[fid]) delete BLOCKED[fid];
    }

    EVAL_MEM[fid] = { snapshot: snap, heuristic: heur, at: Date.now() };

    if (!silent) {
      $("out").textContent = JSON.stringify({
        jogo: snap.match,
        minuto: snap.minute,
        placar: snap.score,
        corners_total: snap.corners_total,
        shots_total: snap.shots_total,
        shots_on_target: snap.shots_on_target,
        bloqueado: !!BLOCKED[fid],
        motivo_bloqueio: BLOCKED[fid] || "",
        recomendacao: heur
      }, null, 2);
    }

    renderLiveList();
    renderBestNow();
    renderFavList();
    renderMeta();
    setStatus("Pronto");

    // alerta: ENTRAR + conf>=min
    const minAlert = Number($("alertMin").value || 80);
    const conf = Number(heur?.confianca || 0);
    const shouldAlert = (heur?.acao === "ENTRAR" && conf >= minAlert && !BLOCKED[fid]);

    if (shouldAlert && (Date.now() - lastAlertAt) > ALERT_COOLDOWN_MS) {
      lastAlertAt = Date.now();
      beep();
      alert(`ALERTA: ENTRAR ‚Ä¢ conf ${conf} ‚Ä¢ ${heur.linha_sugerida}\n${snap.match} (${snap.score})`);
      showTab("tab-best");
    }

    return { ok:true, fixture_id: fid, snapshot: snap, heuristic: heur };
  }

  // ===== Auto Top 5 =====
  async function evaluateTop5Generic({ preferTopLeagues }) {
    if (!LIVE_MEM.length) { alert("Primeiro clique em ‚ÄúCarregar jogos ao vivo‚Äù."); return; }
    if (AUTO_RUNNING) return;

    AUTO_RUNNING = true;
    const token = ++AUTO_TOKEN;
    setStatus("Auto rodando...");

    $("evalTop5").disabled = true;
    $("evalTop5Leagues").disabled = true;
    $("loadLive").disabled = true;

    try {
      const filter = norm($("filter").value);
      let candidates = LIVE_MEM.filter(x => {
        const m = Number(x.minute || 0);
        if (!inRankWindow(m)) return false;
        if (filter) {
          const blob = norm(`${x.country} ${x.league} ${x.home} ${x.away}`);
          if (!blob.includes(filter)) return false;
        }
        return true;
      });

      if (preferTopLeagues) {
        const onlyTop = candidates.filter(isTopLeague);
        candidates = onlyTop.length ? onlyTop : candidates;
      }

      candidates = candidates.sort((a,b) => {
        const am = Number(a.minute||0), bm = Number(b.minute||0);
        const aMid = Math.abs(45 - am);
        const bMid = Math.abs(45 - bm);
        const aScore = (a.score==="0-0"||a.score==="1-0"||a.score==="0-1"||a.score==="1-1") ? 0 : 1;
        const bScore = (b.score==="0-0"||b.score==="1-0"||b.score==="0-1"||b.score==="1-1") ? 0 : 1;
        const aTop = preferTopLeagues ? (isTopLeague(a)?0:1) : 0;
        const bTop = preferTopLeagues ? (isTopLeague(b)?0:1) : 0;
        return (aTop - bTop) || (aScore - bScore) || (aMid - bMid);
      });

      const pick = candidates.slice(0, 5);
      if (!pick.length) { alert("N√£o achei jogos na janela 15‚Äì75 agora. Remova filtro ou aguarde."); return; }

      const cd = Math.max(1, Number($("cooldown").value || 10)) * 1000;
      const gap = Math.max(cd + 1000, 11000);

      for (let i = 0; i < pick.length; i++) {
        if (!AUTO_RUNNING || token !== AUTO_TOKEN) break;

        const it = pick[i];
        $("autoStatus").value = `Auto ${i+1}/5 ‚Ä¢ min ${it.minute} ‚Ä¢ fixture ${it.fixture_id}`;

        if (!EVAL_MEM[String(it.fixture_id)]) {
          await evaluateFixture(it, { silent: true });
        }
        renderBestNow(); renderMeta();

        if (i < pick.length - 1) {
          $("autoStatus").value = `Aguardando ${Math.round(gap/1000)}s...`;
          await sleep(gap);
        }
      }

      $("autoStatus").value = "Finalizado ‚úÖ";
      setStatus("Auto finalizado ‚úÖ");
      showTab("tab-best");
    } finally {
      AUTO_RUNNING = false;
      $("evalTop5").disabled = false;
      $("evalTop5Leagues").disabled = false;
      $("loadLive").disabled = false;
    }
  }
  async function evaluateTop5() { return evaluateTop5Generic({ preferTopLeagues:false }); }
  async function evaluateTop5Leagues() { return evaluateTop5Generic({ preferTopLeagues:true }); }

  function stopAuto(){
    AUTO_RUNNING = false;
    AUTO_TOKEN++;
    $("autoStatus").value = "Parado.";
    setStatus("Auto parado");
  }

  // ===== Monitor =====
  async function setFixtures() {
    const fid = String($("fx1").value || "").trim();
    if (!fid) { alert("Coloque um fixture no #1"); return; }
    setStatus("Monitorando...");
    const r = await fetch("/api/live/set-fixtures", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ fixture_ids: [fid] })
    });
    await r.json();
    await refreshSnapshots();
    setStatus("Monitorando ‚úÖ");
  }

  async function refreshSnapshots() {
    const r = await fetch("/api/live/snapshots");
    const j = await r.json();
    $("snap").textContent = JSON.stringify(j, null, 2);
  }

  async function forceRefresh() {
    setStatus("For√ßando refresh...");
    await fetch("/api/live/force-refresh", { method: "POST" });
    await refreshSnapshots();
    setStatus("Pronto");
  }

  // ===== Favoritos export/clear =====
  function exportFavs(){
    const blob = new Blob([JSON.stringify(FAVS, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "favs.json";
    a.click();
    URL.revokeObjectURL(url);
  }
  function clearFavs(){
    if (!confirm("Tem certeza que quer apagar seus favoritos?")) return;
    FAVS = {};
    saveFavs();
    renderFavList();
    renderMeta();
  }

  // ===== Wiring =====
  $("loadLive").onclick = loadLive;
  $("evalTop5").onclick = evaluateTop5;
  $("evalTop5Leagues").onclick = evaluateTop5Leagues;
  $("stopAuto").onclick = stopAuto;

  $("setFx").onclick = setFixtures;
  $("force").onclick = forceRefresh;

  $("favExport").onclick = exportFavs;
  $("favClear").onclick = clearFavs;

  $("goBest").onclick = () => showTab("tab-best");
  $("goLive").onclick = () => showTab("tab-live");

  // UI puxa cache do seu servidor (n√£o consome API-Football)
  setInterval(refreshSnapshots, 15000);

  // boot
  loadFavs();
  renderFavList();
  renderMeta();
  $("bestNow").innerHTML = `<div class="item">Carregue jogos e avalie para aparecer ranking.</div>`;
  $("liveList").innerHTML = `<div class="item">Clique em ‚ÄúCarregar jogos ao vivo‚Äù.</div>`;
  setStatus("Pronto");
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(() => {});
    });
  }
</script>
</body>
</html>
